/*!
 * Breeze - Async Flow Control
 * Copyright (c) 2012 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 *
 * @website https://github.com/logicalparadox/breeze/
 */
!function(e,t,n){typeof require=="function"&&typeof exports=="object"&&typeof module=="object"?module.exports=n(e,t):typeof define=="function"&&typeof define.amd=="object"?define(n):t[e]=n(e,t)}("breeze",this,function(e,t){function o(e){return e.length===0?null:e.length===1?e[0]:e}function u(e){if(Array.isArray(e)){var t=[];for(var n=0,r=e.length;n<r;n++)t.push(n);return t}return Object.keys(e)}function a(e,t,n){return function(t,r){var s=e[t];s(function(){var s=arguments[0];if(s)return r(s);var u=i.call(arguments,1),a=o(u);n[t]=a,r()})}}function f(e,t){this._iterator=e,this._concurrency=t||10,this._tasks=[],this._err=!1,this.workers=0}function l(e){function i(e){this.id=e,this.notify=[],this.waitfor=[]}function s(e,i){var o=t[e],u=o.id;if(r[e])return;Array.isArray(i)||(i=[]),i.push(u),r[e]=!0,o.notify.forEach(function(e){if(i.indexOf(e)>=0)throw new Error(u+" can not come before "+e);var t=e.toString(),n=i.map(function(e){return e});s(t,n)}),n.unshift(u)}function o(e){return null!==e&&"undefined"!=typeof e}var t={},n=[],r={};e.forEach(function(e){var n=e[0],r=e[1];t[n]||(t[n]=new i(n)),t[r]||(t[r]=new i(r)),~t[r].waitfor.indexOf(n)||t[r].waitfor.push(n),~t[n].notify.indexOf(r)||t[n].notify.push(r)});try{Object.keys(t).forEach(s)}catch(u){return{error:u}}var a=n.filter(o),f=[];return a.forEach(function(e){var n=t[e];n.notify=n.notify.filter(o),n.waitfor=n.waitfor.filter(o),f.push(n)}),{path:a,graph:f}}function c(e){var t=[],n={};for(var r in e){var i=e[r];if(Array.isArray(i))for(var s=0;s<i.length;s++){var o=i[s];"string"==typeof o?t.push([o,r]):"function"==typeof o&&(n[r]=o)}else n[r]=i,t.push([null,r])}return{edges:t,fns:n}}var n={},r=function(){},i=Array.prototype.slice,s=n.exports={};return s.version="0.4.0",s.nextTick="undefined"==typeof process||!process.nextTick?function(e){setTimeout(e,0)}:process.nextTick,s.forEach=function(e,t,n){n=n||r;if(!e.length)return n();var i=e.length;for(var s=0,o=e.length;s<o;s++)t(e[s],function(t){if(t)return n(t);--i||n(null)})},s.forEachSeries=function(e,t,n){function i(r){if(r==e.length)return n();t(e[r],function(t){if(t)return n(t);i(++r)})}n=n||r;if(!e.length)return n();i(0)},s.parallel=function(e,t){t=t||r;var n=u(e),i=Array.isArray(e)?Array(e.length):{},o=a(e,n,i);if(!n.length)return t();s.forEach(n,o,function(e){if(e)return t(e);t(null,i)})},s.series=function(e,t){t=t||r;var n=u(e),i=Array.isArray(e)?Array(e.length):{},o=a(e,n,i);if(!n.length)return t();s.forEachSeries(n,o,function(e){if(e)return t(e);t(null,i)})},s.atomic=function(){function t(e,t){e.args.unshift(function(){t()},e.key),e.fn.apply(this,e.args)}function n(n){var r=s.queue(t,1);return r.drain=function(){delete e[n]},r}var e={};return function(r,s){var o={key:r,fn:s,args:i.call(arguments,2)},u=e[r]||(e[r]=n(r));u.push(o,null,!0)}},s.queue=function(e,t){var n=new f(e,t);return n},Object.defineProperty(f.prototype,"length",{get:function(){return this._tasks.length}}),f.prototype.push=function(e,t,n){"boolean"==typeof t&&(n=t,t=r),Array.isArray(e)||(e=[e]),t=t||r;var i=this._concurrency,o=this.saturated;for(var u=0,a=e.length;u<a;u++){var f=e[u];this._tasks.push({task:f,cb:t}),o&&this._tasks.length===i&&o(),n&&s.nextTick(this.process.bind(this))}},f.prototype.process=function(){var e=this,t=this._concurrency,n=this._iterator;if(this.workers<t&&this.length&&!this._err){var r=this._tasks.shift();this.empty&&!this.length&&this.empty(),this.workers++,n(r.task,function(){e.workers--;if(e._err)return;var n=arguments[0];n&&(e._err=!0),r.cb&&r.cb.apply(r,arguments);if(n&&e.onerror)return e.onerror(n);e.drain&&e.length+e.workers===0&&e.drain(),e.process()}),this.process()}},f.prototype.onerror=null,f.prototype.saturated=null,f.prototype.empty=null,f.prototype.drain=null,s.dag=function(e,t,n,i){function o(e){return c.filter(function(t){return t.id===e})[0]}function u(e,t){n(e,function(r){var i=o(e);i.notify.forEach(function(t){var n=o(t);n.fulfilled.push(e);var r=n.waitfor.length,i=n.fulfilled.length;r===i&&h.push(t,null,!0)}),t(r)})}function a(e){e.fulfilled=[],e.waitfor.length||h.push(e.id)}i=i||r;var s=l(e);if(s.error)return i(s.error);if(!s.path.length)return i(null);var c=s.graph,h=new f(u,t);c.forEach(a),h.onerror=i,h.drain=i,h.process()},s.dagSeries=function(e,t,n){n=n||r;var i=l(e);if(i.error)return n(i.error);s.forEachSeries(i.path,function(e,n){t(e,n)},n)},s.auto=function(e,t,n){function a(e,t){var n=u[e];n(t)}"function"==typeof t&&(n=t,t=10),n=n||r;var i=c(e),o=i.edges,u=i.fns;s.dag(o,t,a,n)},s.autoSeries=function(e,t){function u(e,t){var n=o[e];n(t)}t=t||r;var n=c(e),i=n.edges,o=n.fns;s.dagSeries(i,u,t)},n.exports})